## 目标

创建一个完整且独立的HTML文件，实现一个使用Three.js的云霄飞车动画。动画包含一个小球沿着复杂3D轨道（管道）运动，最终回到起点并循环往复。

---

## 一、技术栈

- HTML, CSS, JavaScript
- 使用 Three.js 库（通过CDN引入最新版本）
- **单一HTML文件**，可直接在浏览器中运行

---

## 二、场景搭建

### 2.1 渲染器
- 创建全屏 `WebGLRenderer`，开启抗锯齿效果

### 2.2 场景
- 创建 `Scene` 对象
- 背景色：淡粉色
- 地面：灰白色平面，无网格

### 2.3 相机
- 使用 `PerspectiveCamera`
- 初始视角：能看到整个轨道概览

### 2.4 光照
- `AmbientLight`：提供基础环境光
- `DirectionalLight`：制造阴影和高光，增加立体感

---

## 三、云霄飞车轨道

### 3.1 路径定义
使用 `CatmullRomCurve3` 创建3D曲线路径，包含以下元素：

- **爬升和俯冲**：高度剧烈变化
- **螺旋/盘旋**：绕Y轴旋转爬升或下降
- **急转弯**：XZ平面大幅度转弯
- **闭环**：终点平滑连接回起点

**CatmullRomCurve3 参数设置：**
```javascript
new THREE.CatmullRomCurve3(points, true, 'chordal', 0.1)
```
- 推荐使用 `'chordal'` 类型，它在处理不均匀分布的点时比 `'centripetal'` 更能避免锐角
- 张力值建议设置为 0.1-0.3，值越小曲线越平滑圆润
- `'chordal'` 类型特别适合高点密度的曲线，能产生更自然的圆角过渡

### 3.2 轨道模型
- 使用 `TubeGeometry` 基于路径生成管道
- 材质：亚克力质感，半透明白色

**TubeGeometry 参数建议：**
- **路径分段数（tubularSegments）**：建议设置为 800-1500，确保管道足够平滑
  - 分段数越高，管道在曲率变化大的区域越平滑
  - 对于复杂轨道，建议使用 1000 以上
- **径向分段数（radialSegments）**：建议设置为 12-16
  - 使管道截面更圆润，避免多边形感
  - 8 个分段会让管道看起来像八边形，16 个分段更接近圆形
- **性能平衡**：分段数越高渲染开销越大，需要在性能和视觉效果间权衡

### 3.3 轨道结构类型

建议编写辅助函数（如 `generateHelixPoints()`, `generateFunnelPoints()` 等）生成各段路径点，然后组合成完整轨道。

#### 螺旋段 (Helix Section)
- 紧密的螺旋上升或下降轨道
- 使用三角函数控制X和Z坐标，线性改变Y坐标

#### 弹簧/波浪段 (Spring/Wave Section)
- 连续上下起伏的结构
- 对Y轴坐标应用正弦/余弦函数

#### 漏斗结构 (Funnel Drop)
- 小球从高处进入宽口，螺旋下降后从窄口冲出
- 逐渐缩小螺旋半径

#### 抛射与回归 (Launch & Return)
- 抛物线轨道，小球被"弹射"到空中后落回轨道
- 使用抛物线路径点模拟

#### 多层交叉 (Multi-level Crossover)
- 轨道在不同高度层交叉穿梭
- 类似立交桥结构

#### 垂直环 (Loop-the-Loop)
- 完整的360度垂直圆环
- 绘制完整圆形路径

#### 弹珠台式分支 (Pinball-style Segments)
- 局部管道变宽或视觉化分支
- 添加"挡板"或"障碍"装饰元素
- 创建震荡区（路径左右摇摆或Z字形）

### 3.4 确保平滑过渡（重要）

为避免轨道连接处出现直角或锐角：

#### 精确匹配连接点
- 每个生成函数接受 `startPoint` 参数，返回 `endPoint`
- 确保上一段的最后一个点与下一段的第一个点完全相同

#### 添加过渡段
- 不同形状段落之间插入3-5个过渡点
- 过渡点平滑地从一个段落的切线方向过渡到下一个
- 可使用线性插值或贝塞尔曲线

#### 切线连续性
- 考虑每个段落末端的运动方向
- 确保相邻段落方向角度差小于30度
- 使用 `curve.getTangentAt()` 验证切线平滑度

#### 采样点密度

**内部点生成策略：**
- 每个轨道段生成函数内部必须生成足够密集的点，避免在段内部出现折线或锐角
- **螺旋段和漏斗段**：根据圈数动态设置点数，建议每圈至少 50-60 个点
  - 例如：3 圈螺旋需要至少 150-180 个点
- **波浪段**：根据频率动态调整点数，频率越高点数越多
  - 建议使用 `Math.max(100, frequency * 50)` 计算点数
  - 至少 100 个点以确保波形平滑
- **垂直环**：建议至少 60-80 个点以形成完美圆形
- **抛物线段**：建议 50-60 个点确保抛物线流畅

**点平滑算法应用：**
- 在每个生成函数返回点数组之前，对原始点进行平滑处理
- 推荐使用 **Chaikin 平滑算法**：
  - 迭代地在相邻点之间插入新点
  - 在两点之间的 25% 和 75% 位置各插入一个点
  - 建议进行 1-2 次迭代
  - 迭代 1 次点数增加约 2 倍，迭代 2 次增加约 4 倍
- 这种算法特别适合处理通过数学公式生成的规则形状
- 可以有效消除由采样产生的微小折角

**动态点密度：**
- 曲率变化大的区域应该增加点密度
- 可以在生成点后计算相邻点之间的角度变化
- 如果角度变化超过阈值（如 15-20 度），在该区域增加插值点
- 直线段可以使用较少的点，转弯段需要更多点

#### 验证与调试
- 检查相邻点之间的角度变化
- 角度变化超过30度说明可能有尖角
- 建议添加 `validateTrackSmoothness()` 函数
- 开发阶段可在连接处放置标记，使用不同颜色区分段落

### 3.5 轨道质量保证

#### 曲线连续性等级
- 追求 **G1 连续性**（切线方向连续）或更高的 **G2 连续性**（曲率连续）
- **G1 连续**意味着相邻段在连接处方向一致，无尖角
  - 小球通过时没有突然的方向改变
  - 轨道看起来自然流畅
- **G2 连续**意味着转弯的曲率也平滑变化
  - 无突然的加速度变化
  - 提供最佳的乘坐体验

#### 测试方法
- 在开发阶段，可以沿轨道绘制切线向量来可视化轨道方向的连续性
- 检查 `TubeGeometry` 生成的管道是否有任何扭曲、折叠或不自然的角度
- 使用较小的管道半径（如 0.5-1.0）测试时可以更容易看出轨道的不平滑之处
- 在浏览器中以慢速播放动画，观察小球是否有任何"跳跃"或"卡顿"现象

#### 常见问题排查
- **问题：管道某处有明显的"拐点"或"折线"效果**
  - 原因：该处点密度不足或相邻点角度变化过大
  - 解决：增加该段的采样点数，或应用点平滑算法
  
- **问题：管道出现扭曲或自相交**
  - 原因：`TubeGeometry` 的径向分段数不足，或路径曲率过大
  - 解决：增加径向分段数到 16，或减小管道半径
  
- **问题：整体曲线呈现"硬边"效果**
  - 原因：`CatmullRomCurve3` 的张力值过大
  - 解决：降低张力值到 0.1-0.2
  
- **问题：连接处出现锐角**
  - 原因：相邻段的切线方向不连续
  - 解决：在段之间添加过渡点，使用贝塞尔曲线插值

---

## 四、小球动画

### 4.1 模型
- 使用 `SphereGeometry` 和 `MeshStandardMaterial`
- 颜色与管道形成对比，清晰可见

### 4.2 动画实现
- 在 `animate` 循环中使用 `Clock` 获取时间
- 根据时间计算小球在路径上的位置（`.getPointAt()` 方法）
- 更新小球的 `position`
- 循环动画：到达终点后从起点重新开始

---

## 五、相机控制

### 5.1 第一人称视角
- 相机跟随小球
- 位置设置在小球稍后方或正上方
- 使用 `.lookAt()` 让相机看向小球前进方向前方
- 创造身临其境的乘坐体验

### 5.2 第三人称视角（OrbitControls）
- 鼠标滚轮：缩放
- 鼠标左键：旋转相机
- 鼠标右键：平移相机

---

## 六、轨道支架系统

### 6.1 目标
为悬空轨道添加支撑柱，增强真实感和视觉效果。

### 6.2 实现方法

#### 采样轨道点
- 按固定间距（40个单位）沿轨道采样
- 使用 `curve.getPointAt(t)` 获取路径点

#### 生成支架柱
对每个采样点：
- 从轨道点向下（-Y方向）做垂线到地面
- 计算支架高度：**支架高度 = 轨道点高度 - 轨道管道半径 - 地面高度**
  - 支架应连接到轨道外壁而非中心路径线
  - 需要减去 `TubeGeometry` 的半径值
- 使用 `CylinderGeometry` 创建圆柱体（直径0.2单位）
- 放置支架：底部在地面，顶部接触轨道外壁

#### 高度过滤
- 只在轨道离地面高度超过阈值（10个单位）时生成支架
- 避免低矮处支架过于密集

#### 避免重叠（可选）
- **Raycaster检测**：向下发射射线检测是否与现有任何物体相交
- **偏移策略**：检测到重叠时，沿切线方向偏移3单位，如果有重叠则继续偏移

### 6.3 视觉优化
- 使用金属质感的 `MeshStandardMaterial`
- 支架顶部和底部添加装饰件（小圆盘或方块）
- 支架底部添加扁平底座，增加稳固感

---

## 七、实现建议

1. **模块化设计**：为每种轨道结构编写独立生成函数
2. **参数化控制**：使用参数控制轨道尺寸、密度等
3. **性能优化**：合理控制支架数量和几何体复杂度
4. **调试工具**：开发阶段添加可视化辅助（如路径点标记）
5. **曲线平滑优先**：在实现时优先保证轨道的平滑性
   - 宁可多生成一些点也要避免锐角和折线
   - 现代浏览器完全能处理包含数千个点的曲线
   - 平滑的轨道比性能优化更重要，因为不平滑的轨道会严重影响视觉体验
   - 在优化阶段再考虑减少点数，而不是一开始就使用最少的点